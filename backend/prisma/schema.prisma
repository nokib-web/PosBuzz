// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      Role     @default(CASHIER)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sales     Sale[]

  @@index([email])
  @@map("users")
}

enum Role {
  ADMIN
  CASHIER
  MANAGER
}

model Product {
  id                 String          @id @default(uuid())
  name               String
  sku                String          @unique
  price              Decimal         @db.Decimal(10, 2)
  costPrice          Decimal         @default(0) @db.Decimal(10, 2)
  stock_quantity     Int             @default(0)
  lowStockThreshold  Int             @default(5)
  supplierId         String?
  supplier           Supplier?       @relation(fields: [supplierId], references: [id])
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  saleItems          SaleItem[]
  inventoryLogs      InventoryLog[]
  purchaseOrderItems PurchaseOrderItem[]

  @@index([sku])
  @@map("products")
}

model Supplier {
  id             String          @id @default(uuid())
  name           String
  email          String?
  phone          String?
  address        String?
  products       Product[]
  purchaseOrders PurchaseOrder[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@map("suppliers")
}

model Customer {
  id        String       @id @default(uuid())
  name      String
  email     String?      @unique
  phone     String?
  points    Int          @default(0)
  tier      LoyaltyTier  @default(BRONZE)
  sales     Sale[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@map("customers")
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

model Promotion {
  id             String        @id @default(uuid())
  name           String
  description    String?
  type           PromoType
  value          Decimal       @db.Decimal(10, 2) // % or fixed amount
  minSpend       Decimal?      @db.Decimal(10, 2)
  startDate      DateTime
  endDate        DateTime
  active         Boolean       @default(true)
  sales          Sale[]
  createdAt      DateTime      @default(now())

  @@map("promotions")
}

enum PromoType {
  PERCENTAGE
  FIXED_AMOUNT
  BOGO // Buy One Get One
}

model Sale {
  id            String        @id @default(uuid())
  total_amount  Decimal       @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  userId        String
  user          User          @relation(fields: [userId], references: [id])
  customerId    String?
  customer      Customer?     @relation(fields: [customerId], references: [id])
  promotionId   String?
  promotion     Promotion?    @relation(fields: [promotionId], references: [id])
  paymentMethod PaymentMethod @default(CASH)
  items         SaleItem[]
  createdAt     DateTime      @default(now())

  @@index([userId])
  @@index([customerId])
  @@index([createdAt])
  @@map("sales")
}

enum PaymentMethod {
  CASH
  CARD
  OTHER
}

model SaleItem {
  id                 String   @id @default(uuid())
  saleId             String
  sale               Sale     @relation(fields: [saleId], references: [id])
  productId          String
  product            Product  @relation(fields: [productId], references: [id])
  quantity           Int
  price_at_sale      Decimal  @db.Decimal(10, 2)
  cost_price_at_sale Decimal  @default(0) @db.Decimal(10, 2)
  subtotal           Decimal  @db.Decimal(10, 2)

  @@map("sale_items")
}

model InventoryLog {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  type      LogType
  quantity  Int
  notes     String?
  createdAt DateTime @default(now())

  @@map("inventory_logs")
}

enum LogType {
  RESTOCK
  SALE
  ADJUSTMENT
  RETURN
}

model PurchaseOrder {
  id          String              @id @default(uuid())
  supplierId  String
  supplier    Supplier            @relation(fields: [supplierId], references: [id])
  status      POStatus            @default(PENDING)
  totalAmount Decimal             @db.Decimal(10, 2)
  items       PurchaseOrderItem[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  productId       String
  product         Product       @relation(fields: [productId], references: [id])
  quantity        Int
  costAtOrder     Decimal       @db.Decimal(10, 2)

  @@map("purchase_order_items")
}

enum POStatus {
  PENDING
  ORDERED
  RECEIVED
  CANCELLED
}
